"use strict";(globalThis.webpackChunkbittery_docs=globalThis.webpackChunkbittery_docs||[]).push([[5011],{2867:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>t,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"indexer-spec","title":"Indexer Specification","description":"Abstract","source":"@site/docs/indexer-spec.md","sourceDirName":".","slug":"/indexer-spec","permalink":"/indexer-spec","draft":false,"unlisted":false,"editUrl":"https://github.com/bittery-protocol/bittery-docs/edit/main/docs/indexer-spec.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Round Lifecycle State Machine","permalink":"/round-lifecycle"},"next":{"title":"Validation Rules","permalink":"/validation-rules"}}');var d=i(6070),r=i(9438);const t={},c="Indexer Specification",l={},o=[{value:"Abstract",id:"abstract",level:2},{value:"Motivation",id:"motivation",level:2},{value:"Specification",id:"specification",level:2},{value:"Block Scanning",id:"block-scanning",level:3},{value:"BTRY Extraction Rules",id:"btry-extraction-rules",level:3},{value:"Applying BII Constraints",id:"applying-bii-constraints",level:3},{value:"Multi-Indexer Consensus",id:"multi-indexer-consensus",level:3},{value:"API Exposure",id:"api-exposure",level:3},{value:"Expected Fields",id:"expected-fields",level:3},{value:"Data Structures",id:"data-structures",level:2},{value:"Validation",id:"validation",level:2},{value:"Rationale",id:"rationale",level:2},{value:"Security Considerations",id:"security-considerations",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(n.header,{children:(0,d.jsx)(n.h1,{id:"indexer-specification",children:"Indexer Specification"})}),"\n",(0,d.jsx)(n.h2,{id:"abstract",children:"Abstract"}),"\n",(0,d.jsx)(n.p,{children:"This document specifies the responsibilities, data extraction rules, and consensus expectations for Bittery indexers. Indexers observe Bitcoin blocks, detect BII inscriptions and BTRY OP_RETURN payloads, and produce deterministic candidate bet sets for consumption by the ICP final judge."}),"\n",(0,d.jsx)(n.h2,{id:"motivation",children:"Motivation"}),"\n",(0,d.jsx)(n.p,{children:"Independent indexers provide redundancy and transparency by reproducing the same candidate bet set from public chain data. A consistent extraction and consensus process mitigates the risk of adversarial or faulty indexers influencing the round outcome."}),"\n",(0,d.jsx)(n.h2,{id:"specification",children:"Specification"}),"\n",(0,d.jsx)(n.h3,{id:"block-scanning",children:"Block Scanning"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"Indexers MUST track the best-known Bitcoin chain with standard reorg handling."}),"\n",(0,d.jsxs)(n.li,{children:["For every new block, indexers parse all transactions to detect:","\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.strong,{children:"BII inscriptions"}),": Ordinals inscriptions with JSON matching the BII specification."]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.strong,{children:"BTRY OP_RETURN"})," outputs: Scripts beginning with ",(0,d.jsx)(n.code,{children:"OP_RETURN"})," followed by CBOR map."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,d.jsx)(n.h3,{id:"btry-extraction-rules",children:"BTRY Extraction Rules"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"Only one OP_RETURN output per transaction is considered. Transactions with multiple OP_RETURNs SHOULD mark the bet as invalid."}),"\n",(0,d.jsx)(n.li,{children:"The payload MUST decode to a CBOR map following the BTRY specification."}),"\n",(0,d.jsxs)(n.li,{children:["For Bet (",(0,d.jsx)(n.code,{children:"op=1"}),") operations:","\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:["Identify the output paying ",(0,d.jsx)(n.code,{children:"prize_pool_address"})," from the referenced BII."]}),"\n",(0,d.jsxs)(n.li,{children:["Record ",(0,d.jsx)(n.code,{children:"txid"}),", ",(0,d.jsx)(n.code,{children:"vout"}),", ",(0,d.jsx)(n.code,{children:"amount"}),", ",(0,d.jsx)(n.code,{children:"block_height"}),", decoded payload fields, and raw CBOR hex."]}),"\n"]}),"\n"]}),"\n",(0,d.jsxs)(n.li,{children:["For Init (",(0,d.jsx)(n.code,{children:"op=0"}),") and Terminate (",(0,d.jsx)(n.code,{children:"op=2"}),"), record the announcement for audit but do not treat it as a bet."]}),"\n"]}),"\n",(0,d.jsx)(n.h3,{id:"applying-bii-constraints",children:"Applying BII Constraints"}),"\n",(0,d.jsxs)(n.p,{children:["Indexers MUST bind each Bet payload to a BII by matching ",(0,d.jsx)(n.code,{children:"r"})," to ",(0,d.jsx)(n.code,{children:"round_id"})," and checking:"]}),"\n",(0,d.jsxs)(n.ol,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"block_height"})," within ",(0,d.jsx)(n.code,{children:"[start_block, end_block]"}),"."]}),"\n",(0,d.jsxs)(n.li,{children:["Output value to ",(0,d.jsx)(n.code,{children:"prize_pool_address"})," within ",(0,d.jsx)(n.code,{children:"[min_bet_sats, max_bet_sats]"}),"."]}),"\n",(0,d.jsxs)(n.li,{children:["Cumulative tickets do not exceed ",(0,d.jsx)(n.code,{children:"max_tickets"}),"."]}),"\n",(0,d.jsxs)(n.li,{children:["One-to-one correspondence between ",(0,d.jsx)(n.code,{children:"amt"})," and the value sent to the prize pool output."]}),"\n",(0,d.jsxs)(n.li,{children:["Deduplicate by ",(0,d.jsx)(n.code,{children:"(g, r)"})," to avoid replayed transactions."]}),"\n"]}),"\n",(0,d.jsx)(n.h3,{id:"multi-indexer-consensus",children:"Multi-Indexer Consensus"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:["Indexers produce a Merkle root over the ordered candidate bet list for a round. Ordering is by ",(0,d.jsx)(n.code,{children:"(block_height, txid, vout)"}),"."]}),"\n",(0,d.jsxs)(n.li,{children:["Consensus is achieved when at least 2/3 of indexers (by configured quorum) publish identical roots for the same round and chain tip (identified by ",(0,d.jsx)(n.code,{children:"end_block_hash"}),")."]}),"\n",(0,d.jsx)(n.li,{children:"Divergent roots must trigger re-sync and diffing; ICP final judge SHOULD require a supermajority root before accepting the candidate set."}),"\n"]}),"\n",(0,d.jsx)(n.h3,{id:"api-exposure",children:"API Exposure"}),"\n",(0,d.jsx)(n.p,{children:"Indexers MUST expose HTTP endpoints for reproducibility:"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"/round/<round_id>/bets.json"}),": Returns the ordered candidate bet list with fields:","\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"round_id"})}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"block_height"})}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"txid"})}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"vout"})}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"amount"})}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"cbor_hex"})}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"decoded"})," (JSON map of BTRY payload)"]}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"ticket_count"})}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"merkle_proof"})," (optional) proving inclusion in the indexer\u2019s Merkle root"]}),"\n"]}),"\n"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"/round/<round_id>/root.json"}),": Returns ",(0,d.jsx)(n.code,{children:'{ "round_id", "merkle_root", "end_block_hash", "indexer_id", "timestamp" }'}),"."]}),"\n"]}),"\n",(0,d.jsx)(n.h3,{id:"expected-fields",children:"Expected Fields"}),"\n",(0,d.jsxs)(n.p,{children:["Each bet entry in ",(0,d.jsx)(n.code,{children:"bets.json"})," MUST include:"]}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"txid"})," (hex string)"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"vout"})," (integer)"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"amount"})," (integer, satoshis)"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"block_height"})," (integer)"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"round_id"})," (string)"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"op"})," (integer)"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"amt"})," (integer)"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"tid"})," (integer, default 1)"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"g"})," (hex string if present)"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"nums"})," (array of integers if present)"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"cbor_hex"})," (hex string)"]}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"data-structures",children:"Data Structures"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"CandidateBet"}),": ",(0,d.jsx)(n.code,{children:"{txid, vout, amount, block_height, payload, ticket_count}"})]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"IndexerMerkleTree"}),": Merkle tree over ",(0,d.jsx)(n.code,{children:"CandidateBet"})," serialization for consensus."]}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"validation",children:"Validation"}),"\n",(0,d.jsx)(n.p,{children:"Indexers MUST:"}),"\n",(0,d.jsxs)(n.ol,{children:["\n",(0,d.jsxs)(n.li,{children:["Validate BII integrity and cache ",(0,d.jsx)(n.code,{children:"round_id"})," to ",(0,d.jsx)(n.code,{children:"prize_pool_address"})," mappings."]}),"\n",(0,d.jsx)(n.li,{children:"Enforce BTRY decoding and discard malformed payloads."}),"\n",(0,d.jsx)(n.li,{children:"Apply BII constraints during candidate generation."}),"\n",(0,d.jsx)(n.li,{children:"Recompute Merkle roots after reorgs affecting the bet set."}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"rationale",children:"Rationale"}),"\n",(0,d.jsx)(n.p,{children:"Standardizing indexer behavior ensures that the ICP final judge can rely on independently derived candidate sets rather than a single source of truth. Merkle-root consensus offers a lightweight agreement mechanism without introducing new trust assumptions."}),"\n",(0,d.jsx)(n.h2,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.strong,{children:"Adversarial indexers"}),": Supermajority roots mitigate single-indexer corruption."]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.strong,{children:"Reorgs"}),": Candidate sets must be recomputed on chain reorganization to avoid stale data."]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.strong,{children:"Payload abuse"}),": Strict CBOR parsing and OP_RETURN limits reduce resource strain from malformed transactions."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,d.jsx)(n,{...e,children:(0,d.jsx)(a,{...e})}):a(e)}}}]);