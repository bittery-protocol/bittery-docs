"use strict";(globalThis.webpackChunkbittery_docs=globalThis.webpackChunkbittery_docs||[]).push([[2148],{560:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"round-lifecycle","title":"Round Lifecycle State Machine","description":"Abstract","source":"@site/docs/round-lifecycle.md","sourceDirName":".","slug":"/round-lifecycle","permalink":"/round-lifecycle","draft":false,"unlisted":false,"editUrl":"https://github.com/bittery-protocol/bittery-docs/edit/main/docs/round-lifecycle.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"BTRY OP_RETURN Payload Specification","permalink":"/BTRY-payload"},"next":{"title":"Indexer Specification","permalink":"/indexer-spec"}}');var r=n(6070),s=n(9438);const a={},l="Round Lifecycle State Machine",c={},d=[{value:"Abstract",id:"abstract",level:2},{value:"Motivation",id:"motivation",level:2},{value:"Specification",id:"specification",level:2},{value:"States",id:"states",level:3},{value:"Transitions",id:"transitions",level:3},{value:"Reorg Handling",id:"reorg-handling",level:3},{value:"Failure Recovery",id:"failure-recovery",level:3},{value:"Required Confirmations",id:"required-confirmations",level:3},{value:"State Diagram",id:"state-diagram",level:3},{value:"Data Structures",id:"data-structures",level:2},{value:"Validation",id:"validation",level:2},{value:"Rationale",id:"rationale",level:2},{value:"Security Considerations",id:"security-considerations",level:2}];function o(e){const i={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.header,{children:(0,r.jsx)(i.h1,{id:"round-lifecycle-state-machine",children:"Round Lifecycle State Machine"})}),"\n",(0,r.jsx)(i.h2,{id:"abstract",children:"Abstract"}),"\n",(0,r.jsx)(i.p,{children:"This document defines the deterministic lifecycle of a Bittery round, including state transitions, triggers, and handling of reorgs or failures. The lifecycle ensures every participant can reproduce when bets are valid, when randomness is drawn, and when payouts are finalized."}),"\n",(0,r.jsx)(i.h2,{id:"motivation",children:"Motivation"}),"\n",(0,r.jsx)(i.p,{children:"A clear state machine enables independent validators to reach the same conclusion about round status using only on-chain data plus the BII ruleset. Explicit transitions also make failure recovery and reorg handling deterministic."}),"\n",(0,r.jsx)(i.h2,{id:"specification",children:"Specification"}),"\n",(0,r.jsx)(i.h3,{id:"states",children:"States"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"OPEN"}),": Bets are accepted. Height window: ",(0,r.jsx)(i.code,{children:"start_block \u2264 block_height \u2264 end_block"})," from the BII."]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"CLOSED"}),": Betting window has ended, awaiting confirmations before drawing randomness."]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"DRAWING"}),": VRF randomness is executed and winners are selected."]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"FINISHED"}),": Payout transaction is constructed, signed via TSS, and broadcast."]}),"\n"]}),"\n",(0,r.jsx)(i.h3,{id:"transitions",children:"Transitions"}),"\n",(0,r.jsxs)(i.ol,{children:["\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"INIT \u2192 OPEN"}),": Implicit when BII is anchored and the blockchain reaches ",(0,r.jsx)(i.code,{children:"start_block"}),"."]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"OPEN \u2192 CLOSED"}),": Occurs when the first block higher than ",(0,r.jsx)(i.code,{children:"end_block"})," is observed. Bets in blocks above ",(0,r.jsx)(i.code,{children:"end_block"})," are ineligible."]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"CLOSED \u2192 DRAWING"}),": After ",(0,r.jsx)(i.code,{children:"k_confirm"})," blocks (default 6) have confirmed the block containing ",(0,r.jsx)(i.code,{children:"end_block"}),", the ICP final judge begins VRF execution using the confirmed block hash set."]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"DRAWING \u2192 FINISHED"}),": After VRF output is generated and winners are selected, the TSS payout transaction is assembled and signed. Broadcast triggers entry to FINISHED once a transaction ID exists."]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"FINISHED"}),": Terminal state. Any rollover funds are locked to the next round according to BII rules."]}),"\n"]}),"\n",(0,r.jsx)(i.h3,{id:"reorg-handling",children:"Reorg Handling"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsxs)(i.li,{children:["If a reorg changes blocks within the ",(0,r.jsx)(i.code,{children:"k_confirm"})," window after ",(0,r.jsx)(i.code,{children:"end_block"}),", the state reverts to CLOSED and bet eligibility is recomputed using the new chain view."]}),"\n",(0,r.jsx)(i.li,{children:"If a reorg occurs after entering DRAWING but before FINISHED, randomness MUST be recomputed using the new confirmed block hash set to maintain reproducibility."}),"\n",(0,r.jsx)(i.li,{children:"If a payout transaction was already broadcast and becomes invalid due to reorg, a new payout transaction MUST be generated with updated inputs; superseded payouts are marked obsolete."}),"\n"]}),"\n",(0,r.jsx)(i.h3,{id:"failure-recovery",children:"Failure Recovery"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"If TSS signing fails, the system remains in DRAWING and retries until quorum signatures are obtained or a termination instruction is validated."}),"\n",(0,r.jsx)(i.li,{children:"If VRF service is unavailable, the state remains CLOSED until VRF output is produced. No bets are accepted after CLOSED regardless of delay."}),"\n",(0,r.jsxs)(i.li,{children:["Termination signals (",(0,r.jsx)(i.code,{children:"op=2"}),") in OP_RETURN may accelerate closure but MUST still respect block-based state transitions."]}),"\n"]}),"\n",(0,r.jsx)(i.h3,{id:"required-confirmations",children:"Required Confirmations"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.code,{children:"k_confirm"})," (default 6) is applied after ",(0,r.jsx)(i.code,{children:"end_block"})," before randomness is derived."]}),"\n",(0,r.jsx)(i.li,{children:"Additional confirmations for payout finality are implementation-specific but SHOULD be at least 1 block after broadcasting."}),"\n"]}),"\n",(0,r.jsx)(i.h3,{id:"state-diagram",children:"State Diagram"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-mermaid",children:"stateDiagram-v2\n    [*] --\x3e OPEN\n    OPEN --\x3e CLOSED: block_height > end_block\n    CLOSED --\x3e DRAWING: k_confirm after end_block\n    DRAWING --\x3e FINISHED: VRF output + signed payout\n    CLOSED --\x3e CLOSED: reorg within k_confirm\n    DRAWING --\x3e CLOSED: reorg invalidates inputs\n    FINISHED --\x3e [*]\n"})}),"\n",(0,r.jsx)(i.h2,{id:"data-structures",children:"Data Structures"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.code,{children:"RoundState"}),": ",(0,r.jsx)(i.code,{children:"{state, round_id, last_block_seen, k_confirm, vrf_seed, payout_txid}"})]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.code,{children:"BetLedger"}),": ordered list of eligible bets as of CLOSED, recomputed on reorg."]}),"\n"]}),"\n",(0,r.jsx)(i.h2,{id:"validation",children:"Validation"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"Validators MUST only accept bets observed while state is OPEN."}),"\n",(0,r.jsxs)(i.li,{children:["VRF execution MUST use the highest block at height ",(0,r.jsx)(i.code,{children:"end_block"})," after ",(0,r.jsx)(i.code,{children:"k_confirm"})," confirmations."]}),"\n",(0,r.jsx)(i.li,{children:"Payout transactions MUST reference the bet set frozen at the transition to DRAWING."}),"\n"]}),"\n",(0,r.jsx)(i.h2,{id:"rationale",children:"Rationale"}),"\n",(0,r.jsx)(i.p,{children:"The four-state machine balances simplicity with deterministic handling of Bitcoin-specific uncertainties such as reorgs and confirmation depth. Explicit recomputation rules preserve reproducibility across independent verifiers."}),"\n",(0,r.jsx)(i.h2,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Reorg safety"}),": Recomputing eligibility and VRF inputs after reorgs prevents divergent outcomes."]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Finality"}),": Waiting ",(0,r.jsx)(i.code,{children:"k_confirm"})," reduces risk of including bets from transient forks."]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Liveness"}),": DRAWING persists until successful TSS signing, preventing premature termination."]}),"\n"]})]})}function h(e={}){const{wrapper:i}={...(0,s.R)(),...e.components};return i?(0,r.jsx)(i,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}}}]);