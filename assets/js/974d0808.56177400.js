"use strict";(globalThis.webpackChunkbittery_docs=globalThis.webpackChunkbittery_docs||[]).push([[4315],{1517:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>d,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"validation-rules","title":"Validation Rules","description":"Abstract","source":"@site/docs/validation-rules.md","sourceDirName":".","slug":"/validation-rules","permalink":"/validation-rules","draft":false,"unlisted":false,"editUrl":"https://github.com/bittery-protocol/bittery-docs/edit/main/docs/validation-rules.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Indexer Specification","permalink":"/indexer-spec"},"next":{"title":"VRF & Entropy Specification","permalink":"/VRF-spec"}}');var s=n(6070),r=n(9438);const d={},a="Validation Rules",o={},l=[{value:"Abstract",id:"abstract",level:2},{value:"Motivation",id:"motivation",level:2},{value:"Specification",id:"specification",level:2},{value:"Bet Validation",id:"bet-validation",level:3},{value:"Round Validation",id:"round-validation",level:3},{value:"Payout Validation",id:"payout-validation",level:3},{value:"Data Structures",id:"data-structures",level:2},{value:"Rationale",id:"rationale",level:2},{value:"Security Considerations",id:"security-considerations",level:2}];function c(e){const i={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.header,{children:(0,s.jsx)(i.h1,{id:"validation-rules",children:"Validation Rules"})}),"\n",(0,s.jsx)(i.h2,{id:"abstract",children:"Abstract"}),"\n",(0,s.jsx)(i.p,{children:"This document defines the deterministic validation logic executed by the ICP final judge when processing Bittery rounds. The rules ensure that every accepted bet and payout is reproducible from on-chain data and the published BII."}),"\n",(0,s.jsx)(i.h2,{id:"motivation",children:"Motivation"}),"\n",(0,s.jsx)(i.p,{children:"Clear validation rules prevent ambiguity between indexer outputs and final execution. By detailing each constraint, independent implementations can achieve identical results while detecting malformed or adversarial inputs."}),"\n",(0,s.jsx)(i.h2,{id:"specification",children:"Specification"}),"\n",(0,s.jsx)(i.p,{children:"Validation operates on the candidate bet set produced by indexers and verified against Bitcoin full-node data. All checks are deterministic and must be applied in the order described."}),"\n",(0,s.jsx)(i.h3,{id:"bet-validation",children:"Bet Validation"}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"UTXO verification"}),": Confirm the referenced transaction exists on the active chain with at least ",(0,s.jsx)(i.code,{children:"k_confirm"})," confirmations at DRAWING time. Validate output value and script type."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Prize address match"}),": Ensure the transaction pays ",(0,s.jsx)(i.code,{children:"prize_pool_address"})," exactly as specified in the BII."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Amount bounds"}),": The output amount must satisfy ",(0,s.jsx)(i.code,{children:"min_bet_sats \u2264 amount \u2264 max_bet_sats"})," and match the ",(0,s.jsx)(i.code,{children:"amt"})," declared in the BTRY payload."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Round window"}),": The block height containing the transaction must be within ",(0,s.jsx)(i.code,{children:"[start_block, end_block]"}),"."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Round identifier"}),": ",(0,s.jsx)(i.code,{children:"payload.r"})," must equal ",(0,s.jsx)(i.code,{children:"BII.round_id"}),"."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Ticket count"}),": ",(0,s.jsx)(i.code,{children:"tid"})," defaults to 1 if absent. Reject if ",(0,s.jsx)(i.code,{children:"tid < 1"})," or cumulative tickets exceed ",(0,s.jsx)(i.code,{children:"max_tickets"}),"."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Replay protection"}),": Reject bets with duplicate ",(0,s.jsx)(i.code,{children:"(g, r)"})," tuples or duplicate ",(0,s.jsx)(i.code,{children:"(txid, vout)"})," references."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"OP_RETURN uniqueness"}),": Reject transactions containing multiple OP_RETURN outputs or non-canonical BTRY encodings."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Malformed payloads"}),": Reject if CBOR decoding fails, required keys are missing, or unsupported ",(0,s.jsx)(i.code,{children:"v"}),"/",(0,s.jsx)(i.code,{children:"op"})," values are present."]}),"\n"]}),"\n",(0,s.jsx)(i.h3,{id:"round-validation",children:"Round Validation"}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"BII integrity"}),": Recompute ",(0,s.jsx)(i.code,{children:"metadata_hash"})," and enforce version compatibility."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Ticket floor"}),": If ",(0,s.jsx)(i.code,{children:"min_tickets"})," is not met by the end of CLOSED, mark the round for refund handling as defined in TSS settlement."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Rollover accounting"}),": Track residual funds designated for rollover; ensure they are excluded from current-round payouts."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"VRF input freeze"}),": At transition to DRAWING, freeze the ordered eligible bet set and the block hash seed set. Any later reorg triggers recomputation and invalidates prior randomness."]}),"\n"]}),"\n",(0,s.jsx)(i.h3,{id:"payout-validation",children:"Payout Validation"}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Winner selection"}),": Derive winner indices using VRF as defined in the VRF specification. Ensure indices map to the frozen bet list."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Amount distribution"}),": Compute prize splits using ",(0,s.jsx)(i.code,{children:"payout_policy"}),". Sum of all outputs MUST equal the prize pool minus fees, respecting basis point allocations."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"TSS signature verification"}),": Verify the payout transaction carries valid threshold signatures from the configured TSS key set."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Change handling"}),": Confirm any change output returns to the designated change address or rollover address specified for the round."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Double-spend check"}),": Ensure inputs funding the payout transaction are unspent at time of broadcast."]}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"data-structures",children:"Data Structures"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"ValidatedBet"}),": ",(0,s.jsx)(i.code,{children:"{txid, vout, amount, ticket_count, payload}"})]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"RoundContext"}),": ",(0,s.jsx)(i.code,{children:"{bii, eligible_bets, block_hash_seed, vrf_output}"})]}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"rationale",children:"Rationale"}),"\n",(0,s.jsx)(i.p,{children:"Applying strict validation at the ICP layer ensures the protocol remains stateless and reproducible. Replay and duplication checks prevent inflation of ticket counts, while block-based constraints tie eligibility to immutable chain history."}),"\n",(0,s.jsx)(i.h2,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Adversarial payloads"}),": Strict schema enforcement and OP_RETURN uniqueness mitigate malformed data attacks."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Replay and duplication"}),": Deduplication on both ",(0,s.jsx)(i.code,{children:"(g, r)"})," and ",(0,s.jsx)(i.code,{children:"(txid, vout)"})," prevents replays across forks or mempool rebroadcasts."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Reorg resilience"}),": Freezing inputs at DRAWING and recomputing upon reorg preserves consistency across verifiers."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"TSS assurance"}),": Verifying threshold signatures ensures only authorized key shares can spend the prize pool."]}),"\n"]})]})}function h(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,s.jsx)(i,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}}}]);