"use strict";(globalThis.webpackChunkbittery_docs=globalThis.webpackChunkbittery_docs||[]).push([[5030],{4062:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"BTRY-payload","title":"BTRY OP_RETURN Payload Specification","description":"Abstract","source":"@site/docs/BTRY-payload.md","sourceDirName":".","slug":"/BTRY-payload","permalink":"/BTRY-payload","draft":false,"unlisted":false,"editUrl":"https://github.com/bittery-protocol/bittery-docs/edit/main/docs/BTRY-payload.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Bittery Issuance Inscription (BII) Specification","permalink":"/BII-spec"},"next":{"title":"Round Lifecycle State Machine","permalink":"/round-lifecycle"}}');var t=n(6070),r=n(9438);const a={},d="BTRY OP_RETURN Payload Specification",o={},l=[{value:"Abstract",id:"abstract",level:2},{value:"Motivation",id:"motivation",level:2},{value:"Specification",id:"specification",level:2},{value:"Common Keys",id:"common-keys",level:3},{value:"Operation-Specific Fields",id:"operation-specific-fields",level:3},{value:"Encoding Rules",id:"encoding-rules",level:3},{value:"Examples",id:"examples",level:3},{value:"Bet Payload (CBOR diagnostic)",id:"bet-payload-cbor-diagnostic",level:4},{value:"Bet Payload Hex",id:"bet-payload-hex",level:4},{value:"Versioning and Backwards Compatibility",id:"versioning-and-backwards-compatibility",level:3},{value:"Data Structures",id:"data-structures",level:2},{value:"Validation",id:"validation",level:2},{value:"Rationale",id:"rationale",level:2},{value:"Security Considerations",id:"security-considerations",level:2},{value:"Termination Semantics",id:"termination-semantics",level:2}];function c(e){const i={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.header,{children:(0,t.jsx)(i.h1,{id:"btry-op_return-payload-specification",children:"BTRY OP_RETURN Payload Specification"})}),"\n",(0,t.jsx)(i.h2,{id:"abstract",children:"Abstract"}),"\n",(0,t.jsx)(i.p,{children:"This document specifies the CBOR-encoded BTRY payload embedded in Bitcoin OP_RETURN outputs. BTRY payloads convey deterministic metadata for initializing rounds, placing bets, and signaling termination. The schema ensures versioned, reproducible parsing across indexers and execution environments."}),"\n",(0,t.jsx)(i.h2,{id:"motivation",children:"Motivation"}),"\n",(0,t.jsx)(i.p,{children:"Bitcoin lacks native smart contract logic. BTRY payloads supply structured metadata that binds a transaction to a Bittery round, describing the action taken and parameters required for validation. A compact CBOR map keeps fees predictable while enabling extensibility through versioned keys."}),"\n",(0,t.jsx)(i.h2,{id:"specification",children:"Specification"}),"\n",(0,t.jsx)(i.p,{children:"BTRY payloads are encoded as CBOR major type 5 (map). Keys are small integers to minimize size. Unknown keys MUST be ignored by parsers for forward compatibility. All amounts are integers in satoshis unless stated otherwise."}),"\n",(0,t.jsx)(i.h3,{id:"common-keys",children:"Common Keys"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"v"})," (unsigned int, required): Payload version. Baseline value: ",(0,t.jsx)(i.code,{children:"1"}),". Major bumps indicate breaking changes."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"op"})," (unsigned int, required): Operation code. Defined values:","\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"0"}),": Init (round publication reference)"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"1"}),": Bet"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"2"}),": Terminate (issuer signal or end-of-round anchor)"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"g"})," (byte string, optional): Global identifier for idempotency (32 bytes recommended). Used with ",(0,t.jsx)(i.code,{children:"r"})," to prevent replay."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"r"})," (byte string, required for Bet/Term): Round identifier (matching BII ",(0,t.jsx)(i.code,{children:"round_id"}),"). For Init, ",(0,t.jsx)(i.code,{children:"r"})," references the announced round id."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"ts"})," (unsigned int, optional): Unix timestamp when the payload was created (advisory only)."]}),"\n"]}),"\n",(0,t.jsx)(i.h3,{id:"operation-specific-fields",children:"Operation-Specific Fields"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsxs)(i.strong,{children:["Init (",(0,t.jsx)(i.code,{children:"op=0"}),")"]}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"bii"})," (byte string, optional): SHA-256 hash of the BII inscription content. Allows OP_RETURN announcement to prove BII integrity."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"addr"})," (text, optional): Prize pool address preview; MUST match the BII field if provided."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsxs)(i.strong,{children:["Bet (",(0,t.jsx)(i.code,{children:"op=1"}),")"]}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"amt"})," (unsigned int, required): Declared bet amount in satoshis. MUST equal the value sent to ",(0,t.jsx)(i.code,{children:"prize_pool_address"}),"."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"nums"})," (array, optional): Chosen numbers for visualization. Each element unsigned int. Maximum length 16. Validators do not interpret; used only for UI."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"tid"})," (unsigned int, optional): Ticket count for multi-ticket bets. Defaults to 1. Validators MUST ensure total tickets do not exceed BII ",(0,t.jsx)(i.code,{children:"max_tickets"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsxs)(i.strong,{children:["Terminate (",(0,t.jsx)(i.code,{children:"op=2"}),")"]}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"reason"})," (text, optional): Freeform rationale (e.g., round aborted)."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"sig"})," (byte string, optional): Optional issuer attestation (implementation-defined) to authenticate termination notices."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(i.h3,{id:"encoding-rules",children:"Encoding Rules"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsx)(i.li,{children:"CBOR canonical ordering (sorted by key) SHOULD be used to guarantee deterministic hashes."}),"\n",(0,t.jsxs)(i.li,{children:["The OP_RETURN script MUST begin with ",(0,t.jsx)(i.code,{children:"OP_RETURN <cbor_bytes>"})," with a maximum total script size of 80 bytes on Bitcoin mainnet unless using extensions that permit larger payloads; implementations SHOULD target \u226480 bytes."]}),"\n",(0,t.jsxs)(i.li,{children:["The ",(0,t.jsx)(i.code,{children:"amt"})," value MUST equal the sum of all outputs to ",(0,t.jsx)(i.code,{children:"prize_pool_address"})," within the transaction for this bet."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"g"})," + ",(0,t.jsx)(i.code,{children:"r"})," uniquely identify the bet attempt; duplicate pairs MUST be rejected by validators."]}),"\n"]}),"\n",(0,t.jsx)(i.h3,{id:"examples",children:"Examples"}),"\n",(0,t.jsx)(i.h4,{id:"bet-payload-cbor-diagnostic",children:"Bet Payload (CBOR diagnostic)"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:"{\n  1: 1,        // v = 1\n  2: 1,        // op = Bet\n  3: h'6f726f756e643132', // r = \"round12\"\n  4: h'01aa',  // g = random id\n  5: 150000,   // amt\n  6: [5, 12, 23, 34, 45], // nums\n  7: 1         // tid\n}\n"})}),"\n",(0,t.jsx)(i.h4,{id:"bet-payload-hex",children:"Bet Payload Hex"}),"\n",(0,t.jsx)(i.p,{children:"Canonical CBOR encoding for the above example:"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:'a7               # map(7)\n01 01            # 1:1 (v)\n02 01            # 2:1 (op=Bet)\n03 486f726f756e643132 # 3:h"6f726f756e643132" (r)\n04 4201aa        # 4:h"01aa" (g)\n05 1a000249f0    # 5:150000 (amt)\n06 8505180c1817 1822182d # 6:[5,12,23,34,45]\n07 01            # 7:1 (tid)\n'})}),"\n",(0,t.jsx)(i.h3,{id:"versioning-and-backwards-compatibility",children:"Versioning and Backwards Compatibility"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:["Parsers MUST support ",(0,t.jsx)(i.code,{children:"v=1"})," and ignore unknown keys \u22658."]}),"\n",(0,t.jsxs)(i.li,{children:["When a new major version is introduced, the ",(0,t.jsx)(i.code,{children:"v"})," field MUST change and incompatible payloads MUST be rejected unless explicitly opted in."]}),"\n",(0,t.jsx)(i.li,{children:"Optional fields MAY be added with new integer keys; existing validators MUST ignore unknown keys but continue enforcing known constraints."}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"data-structures",children:"Data Structures"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"BTRYPayload"}),": Internal representation after decoding CBOR, containing version, op, identifiers, amounts, and auxiliary data."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"BetAction"}),": Subset of fields required to evaluate bet eligibility: ",(0,t.jsx)(i.code,{children:"{round_id, amount, ticket_count, entropy_inputs}"}),"."]}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"validation",children:"Validation"}),"\n",(0,t.jsxs)(i.ol,{children:["\n",(0,t.jsx)(i.li,{children:"Decode CBOR map; reject non-map or missing required keys."}),"\n",(0,t.jsxs)(i.li,{children:["Verify ",(0,t.jsx)(i.code,{children:"v"})," is supported."]}),"\n",(0,t.jsxs)(i.li,{children:["Verify ",(0,t.jsx)(i.code,{children:"op"})," is one of ",2,"."]}),"\n",(0,t.jsxs)(i.li,{children:["For Bet operations, ensure ",(0,t.jsx)(i.code,{children:"amt"})," matches transaction outputs to ",(0,t.jsx)(i.code,{children:"prize_pool_address"})," and satisfies BII bounds."]}),"\n",(0,t.jsxs)(i.li,{children:["Enforce replay protection: reject duplicate ",(0,t.jsx)(i.code,{children:"(g, r)"})," pairs."]}),"\n",(0,t.jsxs)(i.li,{children:["Enforce ",(0,t.jsx)(i.code,{children:"tid"})," \u2265 1 and cumulative tickets \u2264 BII ",(0,t.jsx)(i.code,{children:"max_tickets"}),"."]}),"\n",(0,t.jsx)(i.li,{children:"Ensure OP_RETURN is unique within the transaction and that only one BTRY payload is present."}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"rationale",children:"Rationale"}),"\n",(0,t.jsx)(i.p,{children:"A compact CBOR map minimizes transaction size while keeping clear semantics via small integer keys. Explicit operation codes allow a single parser to handle multiple lifecycle events. Ignoring unknown keys ensures future extensibility without breaking older validators."}),"\n",(0,t.jsx)(i.h2,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Replay protection"}),": The ",(0,t.jsx)(i.code,{children:"(g, r)"})," tuple prevents duplicate processing of the same bet attempt."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Amount binding"}),": Explicit ",(0,t.jsx)(i.code,{children:"amt"})," ensures metadata cannot lie about the satoshi value, enabling reproducible validation."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Integrity"}),": Canonical CBOR ordering enables deterministic hashing for audits."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Abuse mitigation"}),": Validators MUST reject payloads exceeding the size limit or containing malformed types to avoid resource exhaustion."]}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"termination-semantics",children:"Termination Semantics"}),"\n",(0,t.jsxs)(i.p,{children:["Terminate (",(0,t.jsx)(i.code,{children:"op=2"}),") is an advisory signal. ICP final judge MUST corroborate termination against BII state (e.g., expired round, issuer authorization) before concluding the round."]})]})}function h(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,t.jsx)(i,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}}}]);