<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-round-lifecycle" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.3">
<title data-rh="true">Round Lifecycle State Machine | Bittery Protocol</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.bittery.dev/round-lifecycle"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Round Lifecycle State Machine | Bittery Protocol"><meta data-rh="true" name="description" content="Abstract"><meta data-rh="true" property="og:description" content="Abstract"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.bittery.dev/round-lifecycle"><link data-rh="true" rel="alternate" href="https://docs.bittery.dev/round-lifecycle" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.bittery.dev/round-lifecycle" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.2fb61cec.css">
<script src="/assets/js/runtime~main.b48b575b.js" defer="defer"></script>
<script src="/assets/js/main.e8908bf0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_xw8s" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"></a></div><div class="navbar__items navbar__items--right"><div class="toggle_MtT2 colorModeToggle_jbcz"><button class="clean-btn toggleButton_X9qf toggleButtonDisabled_zXIt" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_fLuu"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_B5MR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_ZF44"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_mSeP"><div class="docsWrapper_iwwn"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Bvbq" type="button"></button><div class="docRoot_VmyI"><main class="docMainContainer_sfZu docMainContainerEnhanced_xrha"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_6DEU"><div class="docItemContainer_w1IO"><article><div class="tocCollapsible_ATFE theme-doc-toc-mobile tocMobile_FwkY"><button type="button" class="clean-btn tocCollapsibleButton_hvI9">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Round Lifecycle State Machine</h1></header>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="abstract">Abstract<a href="#abstract" class="hash-link" aria-label="Direct link to Abstract" title="Direct link to Abstract">​</a></h2>
<p>This document defines the deterministic lifecycle of a Bittery round, including state transitions, triggers, and handling of reorgs or failures. The lifecycle ensures every participant can reproduce when bets are valid, when randomness is drawn, and when payouts are finalized.</p>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="motivation">Motivation<a href="#motivation" class="hash-link" aria-label="Direct link to Motivation" title="Direct link to Motivation">​</a></h2>
<p>A clear state machine enables independent validators to reach the same conclusion about round status using only on-chain data plus the BII ruleset. Explicit transitions also make failure recovery and reorg handling deterministic.</p>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="specification">Specification<a href="#specification" class="hash-link" aria-label="Direct link to Specification" title="Direct link to Specification">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="states">States<a href="#states" class="hash-link" aria-label="Direct link to States" title="Direct link to States">​</a></h3>
<ul>
<li><strong>OPEN</strong>: Bets are accepted. Height window: <code>start_block ≤ block_height ≤ end_block</code> from the BII.</li>
<li><strong>CLOSED</strong>: Betting window has ended, awaiting confirmations before drawing randomness.</li>
<li><strong>DRAWING</strong>: VRF randomness is executed and winners are selected.</li>
<li><strong>FINISHED</strong>: Payout transaction is constructed, signed via TSS, and broadcast.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="transitions">Transitions<a href="#transitions" class="hash-link" aria-label="Direct link to Transitions" title="Direct link to Transitions">​</a></h3>
<ol>
<li><strong>INIT → OPEN</strong>: Implicit when BII is anchored and the blockchain reaches <code>start_block</code>.</li>
<li><strong>OPEN → CLOSED</strong>: Occurs when the first block higher than <code>end_block</code> is observed. Bets in blocks above <code>end_block</code> are ineligible.</li>
<li><strong>CLOSED → DRAWING</strong>: After <code>k_confirm</code> blocks (default 6) have confirmed the block containing <code>end_block</code>, the ICP final judge begins VRF execution using the confirmed block hash set.</li>
<li><strong>DRAWING → FINISHED</strong>: After VRF output is generated and winners are selected, the TSS payout transaction is assembled and signed. Broadcast triggers entry to FINISHED once a transaction ID exists.</li>
<li><strong>FINISHED</strong>: Terminal state. Any rollover funds are locked to the next round according to BII rules.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="reorg-handling">Reorg Handling<a href="#reorg-handling" class="hash-link" aria-label="Direct link to Reorg Handling" title="Direct link to Reorg Handling">​</a></h3>
<ul>
<li>If a reorg changes blocks within the <code>k_confirm</code> window after <code>end_block</code>, the state reverts to CLOSED and bet eligibility is recomputed using the new chain view.</li>
<li>If a reorg occurs after entering DRAWING but before FINISHED, randomness MUST be recomputed using the new confirmed block hash set to maintain reproducibility.</li>
<li>If a payout transaction was already broadcast and becomes invalid due to reorg, a new payout transaction MUST be generated with updated inputs; superseded payouts are marked obsolete.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="failure-recovery">Failure Recovery<a href="#failure-recovery" class="hash-link" aria-label="Direct link to Failure Recovery" title="Direct link to Failure Recovery">​</a></h3>
<ul>
<li>If TSS signing fails, the system remains in DRAWING and retries until quorum signatures are obtained or a termination instruction is validated.</li>
<li>If VRF service is unavailable, the state remains CLOSED until VRF output is produced. No bets are accepted after CLOSED regardless of delay.</li>
<li>Termination signals (<code>op=2</code>) in OP_RETURN may accelerate closure but MUST still respect block-based state transitions.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="required-confirmations">Required Confirmations<a href="#required-confirmations" class="hash-link" aria-label="Direct link to Required Confirmations" title="Direct link to Required Confirmations">​</a></h3>
<ul>
<li><code>k_confirm</code> (default 6) is applied after <code>end_block</code> before randomness is derived.</li>
<li>Additional confirmations for payout finality are implementation-specific but SHOULD be at least 1 block after broadcasting.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="state-diagram">State Diagram<a href="#state-diagram" class="hash-link" aria-label="Direct link to State Diagram" title="Direct link to State Diagram">​</a></h3>
<div class="language-mermaid codeBlockContainer_dHXo theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_d0GV"><pre tabindex="0" class="prism-code language-mermaid codeBlock_CQ3n thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e5Ep"><span class="token-line" style="color:#bfc7d5"><span class="token plain">stateDiagram-v2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    [*] --&gt; OPEN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    OPEN --&gt; CLOSED: block_height &gt; end_block</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    CLOSED --&gt; DRAWING: k_confirm after end_block</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    DRAWING --&gt; FINISHED: VRF output + signed payout</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    CLOSED --&gt; CLOSED: reorg within k_confirm</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    DRAWING --&gt; CLOSED: reorg invalidates inputs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    FINISHED --&gt; [*]</span><br></span></code></pre><div class="buttonGroup_phw9"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_GQM8" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_q26N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_SEg2"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="data-structures">Data Structures<a href="#data-structures" class="hash-link" aria-label="Direct link to Data Structures" title="Direct link to Data Structures">​</a></h2>
<ul>
<li><code>RoundState</code>: <code>{state, round_id, last_block_seen, k_confirm, vrf_seed, payout_txid}</code></li>
<li><code>BetLedger</code>: ordered list of eligible bets as of CLOSED, recomputed on reorg.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="validation">Validation<a href="#validation" class="hash-link" aria-label="Direct link to Validation" title="Direct link to Validation">​</a></h2>
<ul>
<li>Validators MUST only accept bets observed while state is OPEN.</li>
<li>VRF execution MUST use the highest block at height <code>end_block</code> after <code>k_confirm</code> confirmations.</li>
<li>Payout transactions MUST reference the bet set frozen at the transition to DRAWING.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="rationale">Rationale<a href="#rationale" class="hash-link" aria-label="Direct link to Rationale" title="Direct link to Rationale">​</a></h2>
<p>The four-state machine balances simplicity with deterministic handling of Bitcoin-specific uncertainties such as reorgs and confirmation depth. Explicit recomputation rules preserve reproducibility across independent verifiers.</p>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="security-considerations">Security Considerations<a href="#security-considerations" class="hash-link" aria-label="Direct link to Security Considerations" title="Direct link to Security Considerations">​</a></h2>
<ul>
<li><strong>Reorg safety</strong>: Recomputing eligibility and VRF inputs after reorgs prevents divergent outcomes.</li>
<li><strong>Finality</strong>: Waiting <code>k_confirm</code> reduces risk of including bets from transient forks.</li>
<li><strong>Liveness</strong>: DRAWING persists until successful TSS signing, preventing premature termination.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/bittery-protocol/bittery-docs/edit/main/docs/round-lifecycle.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_ps3d" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_skLT"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_qDt5 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#abstract" class="table-of-contents__link toc-highlight">Abstract</a></li><li><a href="#motivation" class="table-of-contents__link toc-highlight">Motivation</a></li><li><a href="#specification" class="table-of-contents__link toc-highlight">Specification</a><ul><li><a href="#states" class="table-of-contents__link toc-highlight">States</a></li><li><a href="#transitions" class="table-of-contents__link toc-highlight">Transitions</a></li><li><a href="#reorg-handling" class="table-of-contents__link toc-highlight">Reorg Handling</a></li><li><a href="#failure-recovery" class="table-of-contents__link toc-highlight">Failure Recovery</a></li><li><a href="#required-confirmations" class="table-of-contents__link toc-highlight">Required Confirmations</a></li><li><a href="#state-diagram" class="table-of-contents__link toc-highlight">State Diagram</a></li></ul></li><li><a href="#data-structures" class="table-of-contents__link toc-highlight">Data Structures</a></li><li><a href="#validation" class="table-of-contents__link toc-highlight">Validation</a></li><li><a href="#rationale" class="table-of-contents__link toc-highlight">Rationale</a></li><li><a href="#security-considerations" class="table-of-contents__link toc-highlight">Security Considerations</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>