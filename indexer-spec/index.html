<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-indexer-spec" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.3">
<title data-rh="true">Indexer Specification | Bittery Protocol</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.bittery.dev/indexer-spec"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Indexer Specification | Bittery Protocol"><meta data-rh="true" name="description" content="Abstract"><meta data-rh="true" property="og:description" content="Abstract"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.bittery.dev/indexer-spec"><link data-rh="true" rel="alternate" href="https://docs.bittery.dev/indexer-spec" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.bittery.dev/indexer-spec" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.2fb61cec.css">
<script src="/assets/js/runtime~main.a65cafe5.js" defer="defer"></script>
<script src="/assets/js/main.e8908bf0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_xw8s" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"></a></div><div class="navbar__items navbar__items--right"><div class="toggle_MtT2 colorModeToggle_jbcz"><button class="clean-btn toggleButton_X9qf toggleButtonDisabled_zXIt" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_fLuu"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_B5MR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_ZF44"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_mSeP"><div class="docsWrapper_iwwn"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Bvbq" type="button"></button><div class="docRoot_VmyI"><main class="docMainContainer_sfZu docMainContainerEnhanced_xrha"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_6DEU"><div class="docItemContainer_w1IO"><article><div class="tocCollapsible_ATFE theme-doc-toc-mobile tocMobile_FwkY"><button type="button" class="clean-btn tocCollapsibleButton_hvI9">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Indexer Specification</h1></header>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="abstract">Abstract<a href="#abstract" class="hash-link" aria-label="Direct link to Abstract" title="Direct link to Abstract">​</a></h2>
<p>This document specifies the responsibilities, data extraction rules, and consensus expectations for Bittery indexers. Indexers observe Bitcoin blocks, detect BII inscriptions and BTRY OP_RETURN payloads, and produce deterministic candidate bet sets for consumption by the ICP final judge.</p>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="motivation">Motivation<a href="#motivation" class="hash-link" aria-label="Direct link to Motivation" title="Direct link to Motivation">​</a></h2>
<p>Independent indexers provide redundancy and transparency by reproducing the same candidate bet set from public chain data. A consistent extraction and consensus process mitigates the risk of adversarial or faulty indexers influencing the round outcome.</p>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="specification">Specification<a href="#specification" class="hash-link" aria-label="Direct link to Specification" title="Direct link to Specification">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="block-scanning">Block Scanning<a href="#block-scanning" class="hash-link" aria-label="Direct link to Block Scanning" title="Direct link to Block Scanning">​</a></h3>
<ul>
<li>Indexers MUST track the best-known Bitcoin chain with standard reorg handling.</li>
<li>For every new block, indexers parse all transactions to detect:<!-- -->
<ul>
<li><strong>BII inscriptions</strong>: Ordinals inscriptions with JSON matching the BII specification.</li>
<li><strong>BTRY OP_RETURN</strong> outputs: Scripts beginning with <code>OP_RETURN</code> followed by CBOR map.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="btry-extraction-rules">BTRY Extraction Rules<a href="#btry-extraction-rules" class="hash-link" aria-label="Direct link to BTRY Extraction Rules" title="Direct link to BTRY Extraction Rules">​</a></h3>
<ul>
<li>Only one OP_RETURN output per transaction is considered. Transactions with multiple OP_RETURNs SHOULD mark the bet as invalid.</li>
<li>The payload MUST decode to a CBOR map following the BTRY specification.</li>
<li>For Bet (<code>op=1</code>) operations:<!-- -->
<ul>
<li>Identify the output paying <code>prize_pool_address</code> from the referenced BII.</li>
<li>Record <code>txid</code>, <code>vout</code>, <code>amount</code>, <code>block_height</code>, decoded payload fields, and raw CBOR hex.</li>
</ul>
</li>
<li>For Init (<code>op=0</code>) and Terminate (<code>op=2</code>), record the announcement for audit but do not treat it as a bet.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="applying-bii-constraints">Applying BII Constraints<a href="#applying-bii-constraints" class="hash-link" aria-label="Direct link to Applying BII Constraints" title="Direct link to Applying BII Constraints">​</a></h3>
<p>Indexers MUST bind each Bet payload to a BII by matching <code>r</code> to <code>round_id</code> and checking:</p>
<ol>
<li><code>block_height</code> within <code>[start_block, end_block]</code>.</li>
<li>Output value to <code>prize_pool_address</code> within <code>[min_bet_sats, max_bet_sats]</code>.</li>
<li>Cumulative tickets do not exceed <code>max_tickets</code>.</li>
<li>One-to-one correspondence between <code>amt</code> and the value sent to the prize pool output.</li>
<li>Deduplicate by <code>(g, r)</code> to avoid replayed transactions.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="multi-indexer-consensus">Multi-Indexer Consensus<a href="#multi-indexer-consensus" class="hash-link" aria-label="Direct link to Multi-Indexer Consensus" title="Direct link to Multi-Indexer Consensus">​</a></h3>
<ul>
<li>Indexers produce a Merkle root over the ordered candidate bet list for a round. Ordering is by <code>(block_height, txid, vout)</code>.</li>
<li>Consensus is achieved when at least 2/3 of indexers (by configured quorum) publish identical roots for the same round and chain tip (identified by <code>end_block_hash</code>).</li>
<li>Divergent roots must trigger re-sync and diffing; ICP final judge SHOULD require a supermajority root before accepting the candidate set.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="api-exposure">API Exposure<a href="#api-exposure" class="hash-link" aria-label="Direct link to API Exposure" title="Direct link to API Exposure">​</a></h3>
<p>Indexers MUST expose HTTP endpoints for reproducibility:</p>
<ul>
<li><code>/round/&lt;round_id&gt;/bets.json</code>: Returns the ordered candidate bet list with fields:<!-- -->
<ul>
<li><code>round_id</code></li>
<li><code>block_height</code></li>
<li><code>txid</code></li>
<li><code>vout</code></li>
<li><code>amount</code></li>
<li><code>cbor_hex</code></li>
<li><code>decoded</code> (JSON map of BTRY payload)</li>
<li><code>ticket_count</code></li>
<li><code>merkle_proof</code> (optional) proving inclusion in the indexer’s Merkle root</li>
</ul>
</li>
<li><code>/round/&lt;round_id&gt;/root.json</code>: Returns <code>{ &quot;round_id&quot;, &quot;merkle_root&quot;, &quot;end_block_hash&quot;, &quot;indexer_id&quot;, &quot;timestamp&quot; }</code>.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="expected-fields">Expected Fields<a href="#expected-fields" class="hash-link" aria-label="Direct link to Expected Fields" title="Direct link to Expected Fields">​</a></h3>
<p>Each bet entry in <code>bets.json</code> MUST include:</p>
<ul>
<li><code>txid</code> (hex string)</li>
<li><code>vout</code> (integer)</li>
<li><code>amount</code> (integer, satoshis)</li>
<li><code>block_height</code> (integer)</li>
<li><code>round_id</code> (string)</li>
<li><code>op</code> (integer)</li>
<li><code>amt</code> (integer)</li>
<li><code>tid</code> (integer, default 1)</li>
<li><code>g</code> (hex string if present)</li>
<li><code>nums</code> (array of integers if present)</li>
<li><code>cbor_hex</code> (hex string)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="data-structures">Data Structures<a href="#data-structures" class="hash-link" aria-label="Direct link to Data Structures" title="Direct link to Data Structures">​</a></h2>
<ul>
<li><code>CandidateBet</code>: <code>{txid, vout, amount, block_height, payload, ticket_count}</code></li>
<li><code>IndexerMerkleTree</code>: Merkle tree over <code>CandidateBet</code> serialization for consensus.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="validation">Validation<a href="#validation" class="hash-link" aria-label="Direct link to Validation" title="Direct link to Validation">​</a></h2>
<p>Indexers MUST:</p>
<ol>
<li>Validate BII integrity and cache <code>round_id</code> to <code>prize_pool_address</code> mappings.</li>
<li>Enforce BTRY decoding and discard malformed payloads.</li>
<li>Apply BII constraints during candidate generation.</li>
<li>Recompute Merkle roots after reorgs affecting the bet set.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="rationale">Rationale<a href="#rationale" class="hash-link" aria-label="Direct link to Rationale" title="Direct link to Rationale">​</a></h2>
<p>Standardizing indexer behavior ensures that the ICP final judge can rely on independently derived candidate sets rather than a single source of truth. Merkle-root consensus offers a lightweight agreement mechanism without introducing new trust assumptions.</p>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="security-considerations">Security Considerations<a href="#security-considerations" class="hash-link" aria-label="Direct link to Security Considerations" title="Direct link to Security Considerations">​</a></h2>
<ul>
<li><strong>Adversarial indexers</strong>: Supermajority roots mitigate single-indexer corruption.</li>
<li><strong>Reorgs</strong>: Candidate sets must be recomputed on chain reorganization to avoid stale data.</li>
<li><strong>Payload abuse</strong>: Strict CBOR parsing and OP_RETURN limits reduce resource strain from malformed transactions.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/bittery-protocol/bittery-docs/edit/main/docs/indexer-spec.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_ps3d" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_skLT"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_qDt5 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#abstract" class="table-of-contents__link toc-highlight">Abstract</a></li><li><a href="#motivation" class="table-of-contents__link toc-highlight">Motivation</a></li><li><a href="#specification" class="table-of-contents__link toc-highlight">Specification</a><ul><li><a href="#block-scanning" class="table-of-contents__link toc-highlight">Block Scanning</a></li><li><a href="#btry-extraction-rules" class="table-of-contents__link toc-highlight">BTRY Extraction Rules</a></li><li><a href="#applying-bii-constraints" class="table-of-contents__link toc-highlight">Applying BII Constraints</a></li><li><a href="#multi-indexer-consensus" class="table-of-contents__link toc-highlight">Multi-Indexer Consensus</a></li><li><a href="#api-exposure" class="table-of-contents__link toc-highlight">API Exposure</a></li><li><a href="#expected-fields" class="table-of-contents__link toc-highlight">Expected Fields</a></li></ul></li><li><a href="#data-structures" class="table-of-contents__link toc-highlight">Data Structures</a></li><li><a href="#validation" class="table-of-contents__link toc-highlight">Validation</a></li><li><a href="#rationale" class="table-of-contents__link toc-highlight">Rationale</a></li><li><a href="#security-considerations" class="table-of-contents__link toc-highlight">Security Considerations</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>