<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-VRF-spec" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.3">
<title data-rh="true">VRF &amp; Entropy Specification | Bittery Protocol</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.bittery.dev/VRF-spec"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="VRF &amp; Entropy Specification | Bittery Protocol"><meta data-rh="true" name="description" content="Abstract"><meta data-rh="true" property="og:description" content="Abstract"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.bittery.dev/VRF-spec"><link data-rh="true" rel="alternate" href="https://docs.bittery.dev/VRF-spec" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.bittery.dev/VRF-spec" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.2fb61cec.css">
<script src="/assets/js/runtime~main.b48b575b.js" defer="defer"></script>
<script src="/assets/js/main.e8908bf0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_xw8s" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"></a></div><div class="navbar__items navbar__items--right"><div class="toggle_MtT2 colorModeToggle_jbcz"><button class="clean-btn toggleButton_X9qf toggleButtonDisabled_zXIt" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_fLuu"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_B5MR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_ZF44"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_mSeP"><div class="docsWrapper_iwwn"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Bvbq" type="button"></button><div class="docRoot_VmyI"><main class="docMainContainer_sfZu docMainContainerEnhanced_xrha"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_6DEU"><div class="docItemContainer_w1IO"><article><div class="tocCollapsible_ATFE theme-doc-toc-mobile tocMobile_FwkY"><button type="button" class="clean-btn tocCollapsibleButton_hvI9">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>VRF &amp; Entropy Specification</h1></header>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="abstract">Abstract<a href="#abstract" class="hash-link" aria-label="Direct link to Abstract" title="Direct link to Abstract">​</a></h2>
<p>This document specifies the entropy sources and verifiable random function (VRF) procedures used to select winners in Bittery rounds. The process is deterministic, reproducible, and anchored to Bitcoin block data to prevent bias.</p>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="motivation">Motivation<a href="#motivation" class="hash-link" aria-label="Direct link to Motivation" title="Direct link to Motivation">​</a></h2>
<p>Bitcoin does not provide native randomness. Bittery requires a transparent and replayable mechanism so that any party can derive the same random output from public inputs. Combining Bitcoin block hashes with a VRF ensures unpredictability before <code>end_block</code> and verifiability afterward.</p>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="specification">Specification<a href="#specification" class="hash-link" aria-label="Direct link to Specification" title="Direct link to Specification">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="entropy-sources">Entropy Sources<a href="#entropy-sources" class="hash-link" aria-label="Direct link to Entropy Sources" title="Direct link to Entropy Sources">​</a></h3>
<ul>
<li><strong>Block Hash Seed</strong>: The Bitcoin block hash at height <code>end_block</code> after <code>k_confirm</code> confirmations. In the event of a reorg, the new confirmed hash replaces the seed.</li>
<li><strong>raw_rand()</strong>: Optional deterministic randomness provided by the execution environment (e.g., ICP’s raw randomness) for additional entropy. Must be recorded for reproduction.</li>
<li><strong>Commit–reveal (optional)</strong>: If configured, participants may include commitments in bets; reveals occurring before DRAWING are concatenated into the entropy transcript. Validators MUST ignore reveals after DRAWING begins.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="vrf-input-construction">VRF Input Construction<a href="#vrf-input-construction" class="hash-link" aria-label="Direct link to VRF Input Construction" title="Direct link to VRF Input Construction">​</a></h3>
<p>The VRF message <code>M</code> is constructed as:</p>
<div class="codeBlockContainer_dHXo theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_d0GV"><pre tabindex="0" class="prism-code language-text codeBlock_CQ3n thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e5Ep"><span class="token-line" style="color:#bfc7d5"><span class="token plain">M = concat(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;Bittery-VRF&quot;,                // domain separator</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  round_id,                      // bytes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end_block_height (uint64 BE),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end_block_hash (32 bytes),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  k_confirm (uint8),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  raw_rand() output if present,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  commit_reveal_transcript if present</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup_phw9"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_GQM8" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_q26N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_SEg2"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="vrf-output">VRF Output<a href="#vrf-output" class="hash-link" aria-label="Direct link to VRF Output" title="Direct link to VRF Output">​</a></h3>
<ul>
<li>The VRF is executed with a round-specific VRF key pair controlled by the ICP canister.</li>
<li>The output is a 64-bit integer <code>R64</code> derived from the VRF hash output by taking the first 8 bytes as big-endian.</li>
<li>The VRF proof MUST accompany <code>R64</code> and be verifiable against the public VRF key.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="winner-mapping">Winner Mapping<a href="#winner-mapping" class="hash-link" aria-label="Direct link to Winner Mapping" title="Direct link to Winner Mapping">​</a></h3>
<p>Given <code>n</code> eligible tickets (expanded from <code>tid</code> counts), winners are selected by deterministic modular mapping:</p>
<div class="codeBlockContainer_dHXo theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_d0GV"><pre tabindex="0" class="prism-code language-text codeBlock_CQ3n thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e5Ep"><span class="token-line" style="color:#bfc7d5"><span class="token plain">for i in 0..(winners_needed-1):</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  index_i = (R64 + i * c) mod n</span><br></span></code></pre><div class="buttonGroup_phw9"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_GQM8" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_q26N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_SEg2"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Where <code>c</code> is a large odd constant (e.g., 0x9e3779b97f4a7c15) to ensure full-period cycling. Duplicate indices must be skipped to preserve unique winners; increment <code>i</code> until required winners are selected.</p>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="visualization-mapping-powerball-style">Visualization Mapping (Powerball-style)<a href="#visualization-mapping-powerball-style" class="hash-link" aria-label="Direct link to Visualization Mapping (Powerball-style)" title="Direct link to Visualization Mapping (Powerball-style)">​</a></h3>
<p>For user-facing visualization, <code>R64</code> can be expanded to five white balls and one red ball:</p>
<div class="codeBlockContainer_dHXo theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_d0GV"><pre tabindex="0" class="prism-code language-text codeBlock_CQ3n thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e5Ep"><span class="token-line" style="color:#bfc7d5"><span class="token plain">white1 = (R64 &gt;&gt; 0)  mod 69</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">white2 = (R64 &gt;&gt; 8)  mod 69</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">white3 = (R64 &gt;&gt; 16) mod 69</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">white4 = (R64 &gt;&gt; 24) mod 69</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">white5 = (R64 &gt;&gt; 32) mod 69</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">red    = (R64 &gt;&gt; 40) mod 26</span><br></span></code></pre><div class="buttonGroup_phw9"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_GQM8" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_q26N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_SEg2"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This mapping is non-authoritative for payouts but provides a reproducible representation.</p>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="data-structures">Data Structures<a href="#data-structures" class="hash-link" aria-label="Direct link to Data Structures" title="Direct link to Data Structures">​</a></h2>
<ul>
<li><code>VRFInput</code>: <code>{round_id, end_block_height, end_block_hash, k_confirm, raw_rand_opt, commit_reveal_transcript}</code></li>
<li><code>VRFOutput</code>: <code>{R64, proof}</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="validation">Validation<a href="#validation" class="hash-link" aria-label="Direct link to Validation" title="Direct link to Validation">​</a></h2>
<ol>
<li>Verify the VRF proof against the public key and message <code>M</code>.</li>
<li>Ensure <code>end_block_hash</code> corresponds to the chain view with <code>k_confirm</code> confirmations after <code>end_block</code>.</li>
<li>Confirm <code>raw_rand()</code> and commit–reveal components (if used) are logged and identical across verifiers.</li>
<li>Confirm winner indices map to the frozen eligible ticket list without duplication.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="rationale">Rationale<a href="#rationale" class="hash-link" aria-label="Direct link to Rationale" title="Direct link to Rationale">​</a></h2>
<p>Using the confirmed <code>end_block_hash</code> anchors randomness to Bitcoin while the VRF proof guarantees publicly verifiable derivation. The modular stepping approach yields uniform selection across ticket space without bias.</p>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="security-considerations">Security Considerations<a href="#security-considerations" class="hash-link" aria-label="Direct link to Security Considerations" title="Direct link to Security Considerations">​</a></h2>
<ul>
<li><strong>Bias resistance</strong>: Waiting for confirmations reduces miner influence over <code>end_block_hash</code>. VRF proof prevents manipulation by the execution environment.</li>
<li><strong>Reorg handling</strong>: Recomputing with the new confirmed hash ensures consistency after chain reorganizations.</li>
<li><strong>Transcript integrity</strong>: All entropy inputs must be recorded to allow third parties to reproduce <code>R64</code>.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/bittery-protocol/bittery-docs/edit/main/docs/VRF-spec.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_ps3d" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_skLT"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_qDt5 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#abstract" class="table-of-contents__link toc-highlight">Abstract</a></li><li><a href="#motivation" class="table-of-contents__link toc-highlight">Motivation</a></li><li><a href="#specification" class="table-of-contents__link toc-highlight">Specification</a><ul><li><a href="#entropy-sources" class="table-of-contents__link toc-highlight">Entropy Sources</a></li><li><a href="#vrf-input-construction" class="table-of-contents__link toc-highlight">VRF Input Construction</a></li><li><a href="#vrf-output" class="table-of-contents__link toc-highlight">VRF Output</a></li><li><a href="#winner-mapping" class="table-of-contents__link toc-highlight">Winner Mapping</a></li><li><a href="#visualization-mapping-powerball-style" class="table-of-contents__link toc-highlight">Visualization Mapping (Powerball-style)</a></li></ul></li><li><a href="#data-structures" class="table-of-contents__link toc-highlight">Data Structures</a></li><li><a href="#validation" class="table-of-contents__link toc-highlight">Validation</a></li><li><a href="#rationale" class="table-of-contents__link toc-highlight">Rationale</a></li><li><a href="#security-considerations" class="table-of-contents__link toc-highlight">Security Considerations</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>