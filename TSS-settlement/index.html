<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-TSS-settlement" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.3">
<title data-rh="true">TSS-Based Settlement and Payout Specification | Bittery Protocol</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.bittery.dev/TSS-settlement"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="TSS-Based Settlement and Payout Specification | Bittery Protocol"><meta data-rh="true" name="description" content="Abstract"><meta data-rh="true" property="og:description" content="Abstract"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.bittery.dev/TSS-settlement"><link data-rh="true" rel="alternate" href="https://docs.bittery.dev/TSS-settlement" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.bittery.dev/TSS-settlement" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.2fb61cec.css">
<script src="/assets/js/runtime~main.a65cafe5.js" defer="defer"></script>
<script src="/assets/js/main.e8908bf0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_xw8s" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"></a></div><div class="navbar__items navbar__items--right"><div class="toggle_MtT2 colorModeToggle_jbcz"><button class="clean-btn toggleButton_X9qf toggleButtonDisabled_zXIt" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_fLuu"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_B5MR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_ZF44"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_mSeP"><div class="docsWrapper_iwwn"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Bvbq" type="button"></button><div class="docRoot_VmyI"><main class="docMainContainer_sfZu docMainContainerEnhanced_xrha"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_6DEU"><div class="docItemContainer_w1IO"><article><div class="tocCollapsible_ATFE theme-doc-toc-mobile tocMobile_FwkY"><button type="button" class="clean-btn tocCollapsibleButton_hvI9">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>TSS-Based Settlement and Payout Specification</h1></header>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="abstract">Abstract<a href="#abstract" class="hash-link" aria-label="Direct link to Abstract" title="Direct link to Abstract">​</a></h2>
<p>This document defines how Bittery executes Bitcoin payouts using threshold signatures (TSS). It covers prize pool address generation, payout transaction composition, royalty and treasury distributions, change handling, rollover logic, and refunds.</p>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="motivation">Motivation<a href="#motivation" class="hash-link" aria-label="Direct link to Motivation" title="Direct link to Motivation">​</a></h2>
<p>Bitcoin requires valid signatures to spend UTXOs. Using TSS provides distributed control over the prize pool, eliminating reliance on a single private key while enabling automated payouts determined by the ICP final judge.</p>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="specification">Specification<a href="#specification" class="hash-link" aria-label="Direct link to Specification" title="Direct link to Specification">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="prize-pool-address-generation">Prize Pool Address Generation<a href="#prize-pool-address-generation" class="hash-link" aria-label="Direct link to Prize Pool Address Generation" title="Direct link to Prize Pool Address Generation">​</a></h3>
<ul>
<li>A round-specific TSS key pair is generated by the signing committee.</li>
<li>The public key is converted to a SegWit Bech32 address (<code>prize_pool_address</code>) and published in the BII.</li>
<li>All bets MUST pay this address; only the TSS committee can spend the UTXO set.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="payout-transaction-structure">Payout Transaction Structure<a href="#payout-transaction-structure" class="hash-link" aria-label="Direct link to Payout Transaction Structure" title="Direct link to Payout Transaction Structure">​</a></h3>
<p>Outputs MUST follow this order unless otherwise specified in BII:</p>
<ol>
<li><strong>Winner outputs</strong>: One output per selected winner, amount determined by <code>payout_policy</code> share.</li>
<li><strong>Treasury outputs</strong>: Distributed according to <code>treasury_outputs</code> weights.</li>
<li><strong>Issuer output</strong>: Amount per <code>issuer_bps</code> share to the issuer address (defined off-chain or via treasury list).</li>
<li><strong>Rollover output</strong>: Residual funds allocated to <code>rollover_target_round_id</code> prize pool address if rollover is enabled.</li>
<li><strong>Change output</strong>: Remaining satoshis after fees, sent to a designated TSS change address.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="amount-calculation">Amount Calculation<a href="#amount-calculation" class="hash-link" aria-label="Direct link to Amount Calculation" title="Direct link to Amount Calculation">​</a></h3>
<ul>
<li>Let <code>P</code> be the sum of all eligible bet inputs to the payout transaction.</li>
<li>Transaction fee <code>F</code> is estimated using current feerate and subtracted from <code>P</code>.</li>
<li>Distributions are calculated in basis points: <code>amount = (P - F) * share_bps / 10_000</code>.</li>
<li>Any dust remainder is added to the change output or, if change is dust, to the largest winner output.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="tss-signing">TSS Signing<a href="#tss-signing" class="hash-link" aria-label="Direct link to TSS Signing" title="Direct link to TSS Signing">​</a></h3>
<ul>
<li>The ICP final judge constructs the unsigned payout transaction referencing unspent prize pool UTXOs.</li>
<li>The transaction digest is broadcast to TSS participants.</li>
<li>Upon collecting threshold signatures (e.g., t-of-n), the aggregated signature is inserted and the transaction is broadcast to Bitcoin.</li>
<li>The resulting <code>txid</code> and raw transaction are recorded for audit.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="rollover-logic">Rollover Logic<a href="#rollover-logic" class="hash-link" aria-label="Direct link to Rollover Logic" title="Direct link to Rollover Logic">​</a></h3>
<ul>
<li>If <code>rollover</code> is true in BII, unallocated funds (including change) are sent to the prize pool address of <code>rollover_target_round_id</code>.</li>
<li>If the target round is not yet initialized, funds remain locked until the subsequent payout transaction spends them with a valid TSS signature.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="refund-logic">Refund Logic<a href="#refund-logic" class="hash-link" aria-label="Direct link to Refund Logic" title="Direct link to Refund Logic">​</a></h3>
<ul>
<li>If <code>min_tickets</code> is not met, the round enters refund mode. The payout transaction instead returns pro-rata funds to the originating bet addresses or to a designated refund address controlled by the operator, as specified by BII notes or implementation policy.</li>
<li>Refund mode still requires TSS signatures to spend the prize pool UTXOs.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_IUu1" id="example-transaction-conceptual">Example Transaction (conceptual)<a href="#example-transaction-conceptual" class="hash-link" aria-label="Direct link to Example Transaction (conceptual)" title="Direct link to Example Transaction (conceptual)">​</a></h3>
<div class="codeBlockContainer_dHXo theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_d0GV"><pre tabindex="0" class="prism-code language-text codeBlock_CQ3n thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e5Ep"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Input: UTXO from prize_pool_address (value: 1.00000000 BTC)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Outputs:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  0: 0.60000000 BTC -&gt; winner1 (P2WPKH)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  1: 0.02000000 BTC -&gt; winner2 (P2WPKH)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  2: 0.02000000 BTC -&gt; winner3 (P2WPKH)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  3: 0.02000000 BTC -&gt; winner4 (P2WPKH)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  4: 0.02000000 BTC -&gt; winner5 (P2WPKH)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  5: 0.10000000 BTC -&gt; treasury split A/B per weights</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  6: 0.10000000 BTC -&gt; issuer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  7: 0.10000000 BTC -&gt; rollover target prize pool</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  8: 0.02000000 BTC -&gt; change address</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Fee: 0.00000000 BTC (for illustration)</span><br></span></code></pre><div class="buttonGroup_phw9"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_GQM8" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_q26N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_SEg2"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="data-structures">Data Structures<a href="#data-structures" class="hash-link" aria-label="Direct link to Data Structures" title="Direct link to Data Structures">​</a></h2>
<ul>
<li><code>PayoutPlan</code>: <code>{inputs, outputs[], fee, rollover_target, change_address}</code></li>
<li><code>TSSSignatureBundle</code>: <code>{participants[], threshold, aggregated_signature}</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="validation">Validation<a href="#validation" class="hash-link" aria-label="Direct link to Validation" title="Direct link to Validation">​</a></h2>
<ol>
<li>Verify all inputs belong to <code>prize_pool_address</code> or prior rollover outputs.</li>
<li>Recompute allocations from eligible bet total and confirm outputs match calculated amounts within dust tolerance.</li>
<li>Validate aggregated TSS signature against the round’s public key.</li>
<li>Ensure no unauthorized outputs exist and ordering matches specification.</li>
<li>Confirm payout transaction is not double-spending and meets mempool policy (fee rate, size).</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="rationale">Rationale<a href="#rationale" class="hash-link" aria-label="Direct link to Rationale" title="Direct link to Rationale">​</a></h2>
<p>TSS enables decentralized control of funds while keeping a single on-chain address for simplicity. Basis point calculations provide deterministic splits that are easy to audit.</p>
<h2 class="anchor anchorWithStickyNavbar_IUu1" id="security-considerations">Security Considerations<a href="#security-considerations" class="hash-link" aria-label="Direct link to Security Considerations" title="Direct link to Security Considerations">​</a></h2>
<ul>
<li><strong>Key compromise</strong>: Distributed key shares reduce single-point failure risk; threshold requirement prevents unilateral spending.</li>
<li><strong>Replay</strong>: Payout transaction references specific UTXOs; replays on forks are mitigated by relying on the active chain state.</li>
<li><strong>Incorrect splits</strong>: Deterministic calculation and validation prevent misallocation of funds.</li>
<li><strong>Rollover custody</strong>: Rollover outputs remain under TSS control, preventing operator seizure.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/bittery-protocol/bittery-docs/edit/main/docs/TSS-settlement.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_ps3d" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_skLT"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_qDt5 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#abstract" class="table-of-contents__link toc-highlight">Abstract</a></li><li><a href="#motivation" class="table-of-contents__link toc-highlight">Motivation</a></li><li><a href="#specification" class="table-of-contents__link toc-highlight">Specification</a><ul><li><a href="#prize-pool-address-generation" class="table-of-contents__link toc-highlight">Prize Pool Address Generation</a></li><li><a href="#payout-transaction-structure" class="table-of-contents__link toc-highlight">Payout Transaction Structure</a></li><li><a href="#amount-calculation" class="table-of-contents__link toc-highlight">Amount Calculation</a></li><li><a href="#tss-signing" class="table-of-contents__link toc-highlight">TSS Signing</a></li><li><a href="#rollover-logic" class="table-of-contents__link toc-highlight">Rollover Logic</a></li><li><a href="#refund-logic" class="table-of-contents__link toc-highlight">Refund Logic</a></li><li><a href="#example-transaction-conceptual" class="table-of-contents__link toc-highlight">Example Transaction (conceptual)</a></li></ul></li><li><a href="#data-structures" class="table-of-contents__link toc-highlight">Data Structures</a></li><li><a href="#validation" class="table-of-contents__link toc-highlight">Validation</a></li><li><a href="#rationale" class="table-of-contents__link toc-highlight">Rationale</a></li><li><a href="#security-considerations" class="table-of-contents__link toc-highlight">Security Considerations</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>